# PokeSharp Audio System - Implementation Plan

> Generated by Hive Mind Collective Intelligence System
> Date: 2025-12-10

## Overview

A 6-phase approach to build a complete audio system for the MonoGame Pokemon engine, starting simple and adding complexity incrementally. Each phase is self-contained and delivers working functionality.

---

## Phase 1: Core Audio Infrastructure
**Goal:** Basic foundation that everything builds on

### Deliverables:
```
Engine/Audio/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IAudioService.cs           # Main interface
â”‚   â”œâ”€â”€ AudioService.cs            # Core implementation
â”‚   â””â”€â”€ SoundEffectManager.cs      # Simple SFX playback
â”œâ”€â”€ Configuration/
â”‚   â””â”€â”€ AudioConfiguration.cs      # Settings (volumes, paths)
â””â”€â”€ Events/
    â””â”€â”€ PlaySoundEvent.cs          # Basic sound event
```

### Features:
- [ ] `IAudioService` interface with volume controls
- [ ] `SoundEffectManager` - lazy loading, fire-and-forget playback
- [ ] `AudioConfiguration` - master/SFX/music volume settings
- [ ] DI registration via `AddAudioServices()`
- [ ] Basic `PlaySoundEvent` for EventBus integration

### Tests:
- [ ] `MockAudioService` for testing without hardware
- [ ] Volume calculation unit tests
- [ ] Sound loading/unloading tests

### Code Size: ~300 lines

---

## Phase 2: General Sound Effects
**Goal:** UI, NPC, and environment sounds working in-game

### Deliverables:
```
Engine/Audio/
â”œâ”€â”€ SoundCategory.cs               # UI, NPC, Environment, etc.
â”œâ”€â”€ Helpers/
â”‚   â””â”€â”€ UISounds.cs                # Static helpers for common sounds
â””â”€â”€ Integration/
    â””â”€â”€ TileSoundHandler.cs        # Hook into TileSteppedOnEvent
```

### Features:
- [ ] Sound categories with separate volume controls
- [ ] UI sound helpers (`PlaySelect()`, `PlayCancel()`, etc.)
- [ ] Integration with `TileSteppedOnEvent` for grass/terrain sounds
- [ ] Integration with `DialogueStartedEvent` for NPC sounds
- [ ] Pitch variation for footsteps (natural feel)
- [ ] Sound preloading for common UI sounds

### Assets to Add:
```
Assets/Audio/SFX/
â”œâ”€â”€ UI/           # 8-10 sounds (menu_select, menu_cancel, etc.)
â”œâ”€â”€ NPC/          # 3-5 sounds (exclamation, question, etc.)
â”œâ”€â”€ Environment/  # 10-15 sounds (door, grass, water, etc.)
â””â”€â”€ Footsteps/    # 5-6 sounds (grass, sand, wood, tile, snow)
```

### Tests:
- [ ] Category volume isolation tests
- [ ] Event integration tests
- [ ] Pitch variation range tests

### Code Size: ~200 lines

---

## Phase 3: Music System
**Goal:** Background music with smooth transitions

### Deliverables:
```
Engine/Audio/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IMusicPlayer.cs            # Music interface
â”‚   â””â”€â”€ MusicPlayer.cs             # Implementation with fading
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ PlayMusicEvent.cs
â”‚   â”œâ”€â”€ StopMusicEvent.cs
â”‚   â””â”€â”€ FadeMusicEvent.cs
â””â”€â”€ Systems/
    â””â”€â”€ MapMusicSystem.cs          # React to map changes
```

### Features:
- [ ] `IMusicPlayer` with Play, Stop, Pause, Resume
- [ ] Fade out / Fade in transitions
- [ ] Crossfade between tracks
- [ ] Integration with existing `Music` component on maps
- [ ] `MapMusicSystem` - auto-play music when map loads
- [ ] Music state machine (Playing, Paused, Fading)
- [ ] Seamless looping (using `SoundEffectInstance` to avoid MediaPlayer gap)

### Assets to Add:
```
Assets/Audio/Music/
â”œâ”€â”€ Towns/        # 5-10 tracks
â”œâ”€â”€ Routes/       # 5-10 tracks
â”œâ”€â”€ Battle/       # 4-5 tracks
â””â”€â”€ Fanfares/     # 5-8 short jingles
```

### Tests:
- [ ] Fade timing accuracy tests
- [ ] Crossfade overlap tests
- [ ] State machine transition tests
- [ ] Loop seamlessness tests

### Code Size: ~400 lines

---

## Phase 4: Pokemon Cry System
**Goal:** All 800+ Pokemon cries with variations

### Deliverables:
```
Engine/Audio/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IPokemonCryManager.cs      # Cry interface
â”‚   â””â”€â”€ PokemonCryManager.cs       # LRU cache, modes, ducking
â”œâ”€â”€ CryMode.cs                     # 12 cry variations
â””â”€â”€ Events/
    â””â”€â”€ PlayCryEvent.cs
```

### Features:
- [ ] `IPokemonCryManager` interface
- [ ] LRU cache (50-100 cries) to manage memory
- [ ] 12 cry modes (Normal, Faint, Weak, Doubles, Encounter, etc.)
- [ ] BGM ducking during cries (reduce to 33%)
- [ ] Pitch/volume modifiers per mode
- [ ] `PlayCryAsync()` for waiting until cry finishes
- [ ] Party Pokemon preloading
- [ ] `PlayCryEvent` for decoupled usage

### Cry Modes (from official Pokemon games):
```csharp
public enum CryMode
{
    Normal = 0,       // Default cry
    Doubles = 1,      // Shortened for double battles
    Encounter = 2,    // Wild encounter (aggressive)
    HighPitch = 3,    // Move: Howl
    EchoStart = 4,    // Move: Hyper Voice (reversed)
    Faint = 5,        // Pokemon fainting
    EchoEnd = 6,      // Move: Hyper Voice (2nd half)
    Roar1 = 7,        // Move: Roar (1st cry)
    Roar2 = 8,        // Move: Roar (2nd cry)
    Growl1 = 9,       // Move: Growl (reversed)
    Growl2 = 10,      // Move: Growl (2nd cry)
    Weak = 11,        // Unhealthy Pokemon (low HP)
    WeakDoubles = 12  // Weak + Doubles
}
```

### Assets to Add:
```
Assets/Audio/Cries/
â”œâ”€â”€ 001.wav    # Bulbasaur
â”œâ”€â”€ 002.wav    # Ivysaur
â”œâ”€â”€ 003.wav    # Venusaur
â””â”€â”€ ...        # 800+ cries (can add incrementally)
```

### Tests:
- [ ] LRU cache eviction tests
- [ ] Cry mode pitch/volume tests
- [ ] BGM ducking timing tests
- [ ] Async completion tests
- [ ] Memory usage under load tests

### Code Size: ~350 lines

---

## Phase 5: Battle Audio
**Goal:** Complete battle sound orchestration

### Deliverables:
```
Engine/Audio/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IBattleAudioManager.cs     # Battle audio interface
â”‚   â””â”€â”€ BattleAudioManager.cs      # Battle orchestration
â””â”€â”€ Events/
    â”œâ”€â”€ PlayMoveSoundEvent.cs
    â””â”€â”€ BattleAudioEvents.cs       # Hit, faint, level up, etc.
```

### Features:
- [ ] `IBattleAudioManager` interface
- [ ] Battle music management (wild, trainer, gym, champion)
- [ ] Move sound effects by type (fire, water, electric, etc.)
- [ ] Hit sounds (normal, super effective, not very effective, critical)
- [ ] Low HP warning loop (beep beep beep)
- [ ] Faint sound + cry
- [ ] Victory fanfares (wild, trainer, gym badge)
- [ ] Experience/level up sounds
- [ ] Auto-restore previous music after battle

### Assets to Add:
```
Assets/Audio/SFX/Battle/
â”œâ”€â”€ Moves/        # 20-30 move type sounds
â”œâ”€â”€ Hits/         # 5-6 hit variations
â”œâ”€â”€ Status/       # Poison, burn, sleep, etc.
â””â”€â”€ System/       # Level up, exp gain, etc.
```

### Tests:
- [ ] Battle sequence integration tests
- [ ] Low HP loop start/stop tests
- [ ] Music restoration tests
- [ ] Move type sound mapping tests

### Code Size: ~400 lines

---

## Phase 6: Advanced Features
**Goal:** Polish and immersion

### Deliverables:
```
Engine/Audio/
â”œâ”€â”€ Components/
â”‚   â”œâ”€â”€ AudioEmitterComponent.cs   # Positional audio
â”‚   â”œâ”€â”€ AmbientZoneComponent.cs    # Area-based ambient
â”‚   â””â”€â”€ MusicZoneComponent.cs      # Auto music switching
â”œâ”€â”€ Systems/
â”‚   â”œâ”€â”€ AudioEmitterSystem.cs      # 3D positioning
â”‚   â”œâ”€â”€ AmbientSoundSystem.cs      # Ambient management
â”‚   â””â”€â”€ MusicZoneSystem.cs         # Zone detection
â””â”€â”€ UI/
    â””â”€â”€ AudioSettingsPanel.cs      # Volume sliders
```

### Features:
- [ ] **Positional Audio** - Sounds get louder/panned based on distance
  - Waterfalls, NPCs calling out, ambient creatures
- [ ] **Ambient Zones** - Area-based background sounds
  - Cave drips, forest birds, ocean waves, city bustle
- [ ] **Music Zones** - Auto-crossfade music by area (for seamless maps)
- [ ] **Audio Settings UI** - Master, Music, SFX sliders
- [ ] **Sound pooling** - Reuse instances for performance
- [ ] **Audio debug console commands** - `audio play`, `audio volume`, etc.

### Tests:
- [ ] Distance attenuation calculation tests
- [ ] Zone overlap priority tests
- [ ] Performance benchmarks (concurrent sound limits)
- [ ] Memory leak detection tests

### Code Size: ~500 lines

---

## Summary

| Phase | Name | Lines | Dependencies | Priority |
|-------|------|-------|--------------|----------|
| **1** | Core Infrastructure | ~300 | None | ðŸ”´ Critical |
| **2** | General Sound Effects | ~200 | Phase 1 | ðŸ”´ Critical |
| **3** | Music System | ~400 | Phase 1 | ðŸŸ¡ High |
| **4** | Pokemon Cries | ~350 | Phase 1, 3 | ðŸŸ¡ High |
| **5** | Battle Audio | ~400 | Phase 1, 3, 4 | ðŸŸ¡ High |
| **6** | Advanced Features | ~500 | All previous | ðŸŸ¢ Medium |

**Total: ~2,150 lines of code**

---

## Dependency Graph

```
Phase 1 (Core)
    â”‚
    â”œâ”€â”€â–º Phase 2 (SFX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                         â”‚
    â””â”€â”€â–º Phase 3 (Music) â”€â”€â–º Phase 4 (Cries) â”€â”´â”€â”€â–º Phase 5 (Battle)
                   â”‚
                   â””â”€â”€â–º Phase 6 (Advanced) [can run parallel after Phase 3]
```

---

## Technical Decisions

### MonoGame Audio API Usage:

| Use Case | API | Reason |
|----------|-----|--------|
| Short SFX | `SoundEffect.Play()` | Fire-and-forget, auto-pooled |
| Controlled SFX | `SoundEffectInstance` | Volume/pitch control, looping |
| Background Music | `SoundEffectInstance` | Seamless loops (MediaPlayer has gaps) |
| Long Music (>30s) | `Song` + `MediaPlayer` | Streaming, lower memory |

### File Formats:

| Type | Format | Reason |
|------|--------|--------|
| Sound Effects | `.wav` (16-bit PCM) | Fast loading, no decompression |
| Pokemon Cries | `.wav` | Short, need pitch control |
| Background Music | `.ogg` | Compressed, patent-free |

### Platform Limits:

| Platform | Max Concurrent Sounds |
|----------|----------------------|
| Desktop | 256 |
| Mobile | 32 |

---

## Asset Organization

```
Assets/Audio/
â”œâ”€â”€ Music/
â”‚   â”œâ”€â”€ Towns/
â”‚   â”‚   â”œâ”€â”€ littleroot.ogg
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Routes/
â”‚   â”‚   â”œâ”€â”€ route101.ogg
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Battle/
â”‚   â”‚   â”œâ”€â”€ wild.ogg
â”‚   â”‚   â”œâ”€â”€ trainer.ogg
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ Fanfares/
â”‚       â”œâ”€â”€ level_up.ogg
â”‚       â”œâ”€â”€ evolution.ogg
â”‚       â””â”€â”€ ...
â”œâ”€â”€ SFX/
â”‚   â”œâ”€â”€ UI/
â”‚   â”‚   â”œâ”€â”€ menu_select.wav
â”‚   â”‚   â”œâ”€â”€ menu_cancel.wav
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ NPC/
â”‚   â”‚   â”œâ”€â”€ exclamation.wav
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Environment/
â”‚   â”‚   â”œâ”€â”€ door_open.wav
â”‚   â”‚   â”œâ”€â”€ grass_step.wav
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Battle/
â”‚   â”‚   â”œâ”€â”€ Moves/
â”‚   â”‚   â”œâ”€â”€ Hits/
â”‚   â”‚   â””â”€â”€ Status/
â”‚   â””â”€â”€ Footsteps/
â”‚       â”œâ”€â”€ step_grass.wav
â”‚       â””â”€â”€ ...
â””â”€â”€ Cries/
    â”œâ”€â”€ 001.wav
    â”œâ”€â”€ 002.wav
    â””â”€â”€ ...
```

---

## References

### MonoGame Documentation:
- [SoundEffect Class](https://docs.monogame.net/api/Microsoft.Xna.Framework.Audio.SoundEffect.html)
- [SoundEffectInstance Class](https://docs.monogame.net/api/Microsoft.Xna.Framework.Audio.SoundEffectInstance.html)
- [Audio Tutorial](https://docs.monogame.net/articles/tutorials/building_2d_games/14_soundeffects_and_music/index.html)
- [Audio Controller Pattern](https://docs.monogame.net/articles/tutorials/building_2d_games/15_audio_controller/)

### Pokemon Audio Research:
- [Pokemon Cries - Bulbapedia](https://bulbapedia.bulbagarden.net/wiki/Cry)
- [Pokemon Essentials Audio Wiki](https://essentialsdocs.fandom.com/wiki/Audio)
- [Pokemon Game Sound Library](https://pokemon-soundlibrary.pokemon.co.jp/)

---

## Next Steps

1. **Start Phase 1** - Create core infrastructure
2. **Add test audio files** - A few placeholder .wav files for testing
3. **Integrate with existing systems** - Hook into EventBus and DI
4. **Iterate** - Add phases as needed for gameplay features

---

*Generated by Hive Mind Collective - Swarm ID: swarm-1765387114165-4x70jjexm*
